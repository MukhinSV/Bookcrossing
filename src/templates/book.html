<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>–ö–Ω–∏–≥–∞</title>
  <link rel="stylesheet" href="/static/app.css">
  <style>
    body {
      min-height: 100vh;
    }
    .book-cover {
      width: 100%;
      max-width: 220px;
      height: auto;
      object-fit: contain;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      background: #fff;
      display: block;
      margin: 0 auto;
    }
    #book-info .book-cover {
      margin-bottom: 1.25rem;
    }
    .book-title-row {
      display: flex;
      align-items: center;
      gap: .5rem;
      flex-wrap: wrap;
      margin-bottom: .5rem;
    }
    .book-status-badge {
      width: 1.95rem;
      height: 1.95rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      font-size: 1.08rem;
      font-weight: 800;
      line-height: 1;
      color: #fff;
      border: 2px solid rgba(255, 255, 255, .95);
      box-shadow: 0 6px 14px rgba(0, 0, 0, .22);
      text-shadow: 0 1px 1px rgba(0, 0, 0, .25);
    }
    .book-status-badge.booked {
      background: #2563eb;
    }
    .book-status-badge.owned {
      background: #16a34a;
    }
    .site-footer {
      background: var(--bg-solid);
      border-top: 1px solid var(--border);
      color: var(--text-muted);
    }
    .site-footer .muted {
      color: var(--text-muted);
    }
  </style>
</head>
<body class="bg-light d-flex flex-column">
  <main class="container py-4 py-md-5 flex-grow-1">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h3 mb-0">–ö–∞—Ä—Ç–æ—á–∫–∞ –∫–Ω–∏–≥–∏</h1>
      <div class="d-flex gap-2">
        <button id="back-btn" type="button" class="btn btn-outline-secondary">–ù–∞–∑–∞–¥</button>
      </div>
    </div>

    <div id="result" class="mb-3" role="status"></div>

    <section class="card shadow-sm mb-4">
      <div class="card-body" id="book-info">
        <p class="text-muted mb-0">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–Ω–∏–≥–µ...</p>
      </div>
    </section>

    <section class="card shadow-sm">
      <div class="card-header fw-semibold">–î–µ–π—Å—Ç–≤–∏—è</div>
      <div class="card-body">
        <div id="actions-area"></div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container py-4 small muted">
      ¬© Bookcrossing. –ß–∏—Ç–∞–π—Ç–µ, –¥–µ–ª–∏—Ç–µ—Å—å, –≤–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ –∫–Ω–∏–≥–∏ –≤ –æ–±–æ—Ä–æ—Ç.
    </div>
  </footer>

  <script src="/static/app.js"></script>
  <script>
    const result = document.getElementById("result");
    const bookInfo = document.getElementById("book-info");
    const actionsArea = document.getElementById("actions-area");
    const backBtn = document.getElementById("back-btn");
    let resultTimer;
    let contextData = null;

    function getBookIdFromPath() {
      const parts = window.location.pathname.split("/").filter(Boolean);
      const bookIndex = parts.indexOf("book");
      if (bookIndex === -1 || bookIndex + 1 >= parts.length) {
        return null;
      }
      return Number(parts[bookIndex + 1]);
    }

    function showResult(type, message, timeoutMs = 4000) {
      clearTimeout(resultTimer);
      result.className = `mb-3 alert alert-${type}`;
      result.textContent = message;
      if (timeoutMs > 0) {
        resultTimer = setTimeout(() => {
          result.className = "mb-3";
          result.textContent = "";
        }, timeoutMs);
      }
    }

    function renderBookInfo(book) {
      if (!book) {
        bookInfo.innerHTML = '<p class="text-danger mb-0">–ö–Ω–∏–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</p>';
        return;
      }
      const imageSrc = resolveBookImage(book.image);
      const statusBadge = getBookStatusBadge(book);
      bookInfo.innerHTML = `
        <div class="row g-3 align-items-start">
          <div class="col-12 col-md-auto">
            <img src="${imageSrc}" alt="${book.title ?? "–û–±–ª–æ–∂–∫–∞ –∫–Ω–∏–≥–∏"}" class="book-cover">
          </div>
          <div class="col">
            <div class="book-title-row">
              <h2 class="h5 mb-0">${book.title ?? "-"}</h2>
              ${statusBadge}
            </div>
            <p class="mb-1"><strong>–ê–≤—Ç–æ—Ä:</strong> ${book.author?.fullname ?? "-"}</p>
            <p class="mb-1"><strong>–ñ–∞–Ω—Ä:</strong> ${book.genre ?? "-"}</p>
            <p class="mb-1"><strong>–ì–æ–¥:</strong> ${book.year ?? "-"}</p>
            <p class="mb-0"><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${book.description ?? "-"}</p>
          </div>
        </div>
      `;
    }

    function getBookStatusBadge(book) {
      if (book?.is_booked_by_user) {
        return '<span class="book-status-badge booked" title="–ö–Ω–∏–≥–∞ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∞ –≤–∞–º–∏" aria-label="–ö–Ω–∏–≥–∞ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∞ –≤–∞–º–∏">üîñ</span>';
      }
      if (book?.is_owned_by_user) {
        return '<span class="book-status-badge owned" title="–ö–Ω–∏–≥–∞ —É –≤–∞—Å" aria-label="–ö–Ω–∏–≥–∞ —É –≤–∞—Å">‚úì</span>';
      }
      return "";
    }

    function resolveBookImage(imageValue) {
      if (!imageValue) {
        return "/imgs/default-book.jpg";
      }
      if (imageValue.startsWith("http://") || imageValue.startsWith("https://") || imageValue.startsWith("/")) {
        return imageValue;
      }
      return `/imgs/${imageValue}`;
    }

    async function handleBooking(bookId, instanceId) {
      try {
        const response = await fetch(`/book/${bookId}/booking/${instanceId}`, {
          method: "POST"
        });
        const data = await response.json();
        if (!response.ok) {
          showResult("danger", data.detail ? String(data.detail) : "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–∏–≥—É");
          return;
        }
        showResult("success", "–ö–Ω–∏–≥–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∞");
        setTimeout(() => {
          window.location.href = "/profile/view";
        }, 700);
      } catch (error) {
        showResult("danger", "–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞");
      }
    }

    function renderActions(bookId, context) {
      const instances = context.instances;
      const booking = context.booking;
      const exchangePoints = context.exchanges_point;

      if (booking) {
        actionsArea.innerHTML = `
          <div class="alert alert-info mb-0">
            –ö–Ω–∏–≥–∞ —É–∂–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∞. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç.
          </div>
        `;
        return;
      }

      if (!instances) {
        actionsArea.innerHTML = `
          <div class="alert alert-secondary mb-0">
            –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–Ω–∏–≥
          </div>
        `;
        return;
      }

      actionsArea.innerHTML = `
        <button id="open-booking-form-btn" type="button" class="btn btn-primary">
          –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å
        </button>
        <div id="booking-form" class="d-none">
          <label for="exchange-select" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –∞–¥—Ä–µ—Å –ø–æ–ª—É—á–µ–Ω–∏—è</label>
          <select id="exchange-select" class="form-select mb-3"></select>
          <button id="confirm-booking-btn" type="button" class="btn btn-success">
            –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –±—Ä–æ–Ω—å
          </button>
        </div>
      `;

      const openBookingBtn = document.getElementById("open-booking-form-btn");
      const bookingForm = document.getElementById("booking-form");
      const exchangeSelect = document.getElementById("exchange-select");
      const confirmBookingBtn = document.getElementById("confirm-booking-btn");

      const points = Array.isArray(exchangePoints) ? exchangePoints : [];
      const sourcePoints = points.length ? points : instances.map((instance) => ({
        id: instance.exchange_point_id,
        address: "–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω"
      }));

      sourcePoints.forEach((point) => {
        const option = document.createElement("option");
        option.value = String(point.id);
        option.textContent = point.address ?? "–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω";
        exchangeSelect.appendChild(option);
      });

      openBookingBtn.addEventListener("click", () => {
        const isHidden = bookingForm.classList.contains("d-none");
        bookingForm.classList.toggle("d-none", !isHidden);
        openBookingBtn.classList.toggle("mb-3", isHidden);
        openBookingBtn.textContent = isHidden ? "–°–∫—Ä—ã—Ç—å –≤—ã–±–æ—Ä –∞–¥—Ä–µ—Å–∞" : "–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å";
      });

      confirmBookingBtn.addEventListener("click", () => {
        const selectedExchangePointId = Number(exchangeSelect.value);
        const selectedInstance = instances.find((instance) => (
          instance.exchange_point_id === selectedExchangePointId
        )) ?? instances[0];

        if (!selectedInstance) {
          showResult("danger", "–°–≤–æ–±–æ–¥–Ω—ã—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ");
          return;
        }

        handleBooking(bookId, selectedInstance.id);
      });
    }

    async function loadBookPage() {
      const bookId = getBookIdFromPath();
      if (!bookId) {
        showResult("danger", "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–Ω–∏–≥–∏");
        return;
      }

      // showResult("info", "–ó–∞–≥—Ä—É–∑–∫–∞...", 0);
      try {
        const response = await fetch(`/book/${bookId}`, {
          method: "GET",
          headers: {"Accept": "application/json"}
        });
        const data = await response.json();
        if (!response.ok) {
          // showResult("danger", data.detail ? String(data.detail) : "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ");
          return;
        }

        contextData = data;
        renderBookInfo(data.book);
        renderActions(bookId, data);
        // showResult("success", "–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã");
      } catch (error) {
        // showResult("danger", "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
      }
    }

    backBtn.addEventListener("click", () => {
      if (window.history.length > 1) {
        window.history.back();
      } else {
        window.location.href = "/main/view";
      }
    });

    loadBookPage();
  </script>
</body>
</html>
